<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMELI'S - Tienda Oficial</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            /* PALETA */
            --primary-blue: #004aad; 
            --dark-blue: #003366;
            --price-red: #da291c;    
            --bg-page: #f6f6f6;
            --white: #ffffff;
            --gray-light: #f9f9f9;
            --border-color: #e6e6e6;
            --green-success: #059669;
            
            --header-height: 70px; /* Altura de la cabecera fija */
        }

        /* RESETEO PARA EVITAR "BAILE" DE PANTALLA */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            width: 100%;
            overflow-x: hidden; /* IMPORTANTE: Bloquea movimiento lateral de la p√°gina */
            overscroll-behavior-y: none; /* Evita rebotes el√°sticos en iPhone */
        }

        body { 
            background-color: var(--bg-page); 
            color: #333; 
            padding-top: var(--header-height); /* Espacio exacto para la cabecera */
            padding-bottom: 80px; 
        }

        /* === 1. HEADER FIJO (SOLO BUSCADOR Y LOGO) === */
        header {
            background: var(--white);
            height: var(--header-height);
            width: 100%;
            position: fixed; /* CLAVADO AL TECHO */
            top: 0; left: 0; 
            z-index: 2000;
            display: flex; align-items: center; gap: 15px; padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .logo { font-size: 1.4rem; font-weight: 900; color: var(--dark-blue); letter-spacing: -1px; white-space: nowrap; }
        .logo span { color: var(--primary-blue); }

        .search-bar-container { flex-grow: 1; position: relative; max-width: 600px; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 15px;
            border: 2px solid var(--primary-blue); border-radius: 25px;
            outline: none; font-size: 0.9rem; background: var(--gray-light);
        }
        .search-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: var(--primary-blue); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* === 2. BANNER NORMAL (SE MUEVE CON EL CONTENIDO) === */
        .flash-banner {
            background: linear-gradient(90deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
            color: white; 
            padding: 8px 15px; /* M√°s delgado */
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; font-weight: 700;
            /* Ya no es fixed, para que no ocupe espacio visual innecesario al bajar */
        }
        .timer-box span { background: white; color: var(--primary-blue); padding: 1px 4px; border-radius: 3px; font-weight: 800; margin: 0 1px; }

        /* === LAYOUT === */
        .main-layout {
            display: grid; grid-template-columns: 1fr 320px; gap: 20px;
            max-width: 1400px; margin: 0 auto; padding: 15px;
        }

        /* FILTROS (SOLO ESTA FILA SE DESLIZA) */
        .categories-scroll {
            display: flex; gap: 10px; 
            overflow-x: auto; /* Permite deslizar horizontalmente */
            padding-bottom: 5px; margin-bottom: 15px; 
            scrollbar-width: none; /* Oculta barra scroll en Firefox */
            overscroll-behavior-x: contain; /* Evita que el deslizamiento afecte a la p√°gina entera */
        }
        .categories-scroll::-webkit-scrollbar { display: none; } /* Oculta barra en Chrome/Safari */

        .cat-pill {
            background: white; border: 1px solid #ddd; padding: 8px 18px; border-radius: 20px;
            font-size: 0.85rem; white-space: nowrap; cursor: pointer; transition: 0.2s; text-transform: capitalize;
            flex-shrink: 0; /* Evita que se aplasten */
        }
        .cat-pill:hover, .cat-pill.active {
            background: #e6f0ff; color: var(--primary-blue); border-color: var(--primary-blue); font-weight: 700;
        }

        /* GRILLA PRODUCTOS */
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;
        }

        .product-card {
            background: white; border-radius: 8px; overflow: hidden; border: 1px solid transparent; transition: 0.3s; cursor: pointer; position: relative;
        }
        /* Efecto presionar en m√≥vil */
        .product-card:active { transform: scale(0.98); } 

        .img-wrapper { position: relative; width: 100%; padding-top: 100%; overflow: hidden; background: #eee; }
        .img-wrapper img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .deal-tag {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0, 74, 173, 0.9); color: white;
            font-size: 0.7rem; padding: 4px; text-align: center; font-weight: bold; text-transform: uppercase;
        }

        .info-wrapper { padding: 10px; }
        .p-title {
            font-size: 0.85rem; color: #333; line-height: 1.3; height: 2.6em; overflow: hidden; margin-bottom: 5px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        .price-row { display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap; }
        .current-price { color: var(--price-red); font-size: 1.1rem; font-weight: 900; }
        .original-price { color: #999; font-size: 0.8rem; text-decoration: line-through; }
        
        .btn-add-cart {
            width: 100%; margin-top: 8px; background: white; border: 1px solid var(--primary-blue); color: var(--primary-blue);
            padding: 6px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-add-cart:active { background: var(--primary-blue); color: white; }

        /* === SIDEBAR (ESCRITORIO) === */
        .cart-sidebar {
            background: white; border-radius: 8px; padding: 15px; height: fit-content; border: 1px solid #ddd;
            position: sticky; top: 90px; max-height: 80vh; overflow-y: auto;
        }
        .cart-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .cart-items { max-height: 300px; overflow-y: auto; font-size: 0.9rem; }
        
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .cart-info { flex-grow: 1; padding-right: 5px; }
        .cart-name { font-size: 0.85rem; font-weight: 500; color: #333; display: block; }
        .cart-price { font-size: 0.8rem; color: #666; }
        
        .cart-controls { display: flex; align-items: center; gap: 5px; background: #f9f9f9; padding: 2px; border-radius: 15px; }
        .qty-btn { background: white; border: 1px solid #eee; width: 22px; height: 22px; border-radius: 50%; font-weight: bold; cursor: pointer; color: var(--primary-blue); }
        .qty-val { font-weight: 700; font-size: 0.85rem; min-width: 15px; text-align: center; }
        .btn-trash { color: var(--price-red); cursor: pointer; font-size: 1rem; padding: 5px; }

        /* Resumen Ocultable */
        .summary-toggle-btn { background: none; border: none; color: #666; font-size: 0.8rem; cursor: pointer; width: 100%; text-align: center; margin: 10px 0 5px 0; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .summary-details { overflow: hidden; transition: max-height 0.3s ease; }
        .summary-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px; color: #555; }
        .summary-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 900; margin-top: 10px; border-top: 2px solid #eee; padding-top: 10px; color: var(--dark-blue); }
        
        .discount-alert { background: #fff7ed; border: 1px solid #ffedd5; color: #9a3412; padding: 8px; border-radius: 8px; font-size: 0.8rem; text-align: center; margin-bottom: 10px; }
        .discount-alert.success { background: #ecfdf5; border-color: #d1fae5; color: #065f46; }

        .btn-checkout { display: block; width: 100%; background: var(--primary-blue); color: white; text-align: center; padding: 12px; border-radius: 30px; text-decoration: none; font-weight: bold; margin-top: 15px; box-shadow: 0 4px 10px rgba(0, 74, 173, 0.3); }
        .btn-keep-shopping { width: 100%; background: transparent; color: #777; border: none; padding: 10px; font-size: 0.85rem; cursor: pointer; text-decoration: underline; margin-top: 5px; }

        /* M√ìVIL */
        .mobile-fab { display: none; }
        .modal { display: none; }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; padding: 10px; }
            .cart-sidebar { display: none; }
            
            .mobile-fab { display: flex; position: fixed; bottom: 20px; right: 20px; background: var(--primary-blue); color: white; width: 60px; height: 60px; border-radius: 50%; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; }
            .mobile-badge { position: absolute; top: -5px; right: -5px; background: var(--price-red); color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
            
            .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; align-items: flex-end; }
            .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto;}
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    </style>
</head>
<body>

    <header>
        <div class="logo">AMELI<span>'</span>S</div>
        <div class="search-bar-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar prendas..." onkeyup="searchProducts()">
            <button class="search-btn"><i class="fas fa-search"></i></button>
        </div>
    </header>

    <div class="flash-banner">
        <div><i class="fas fa-bolt" style="color:#ffc107"></i> Ofertas Flash</div>
        <div class="timer-box" id="countdown">00:00:00</div>
    </div>

    <div class="main-layout">
        
        <div class="content-area">
            <div class="categories-scroll" id="dynamicCategories">
                <div class="cat-pill active">Cargando...</div>
            </div>

            <div class="products-grid" id="productsGrid">
                <div style="text-align:center; padding:40px; color:#999; grid-column:1/-1;">Cargando cat√°logo...</div>
            </div>
        </div>

        <aside class="cart-sidebar">
            <div class="cart-title">Resumen de Pedido</div>
            <div id="desktop-discount-bar" class="discount-alert" style="display:none;"></div>
            <div id="desktop-cart-items" class="cart-items"><p style="color:#999;text-align:center">Vac√≠o</p></div>
            <div id="desktop-cart-summary"></div>
            <a href="#" class="btn-checkout" onclick="checkout()">Finalizar Compra</a>
            <button class="btn-keep-shopping" onclick="window.scrollTo(0,0)">Seguir comprando</button>
        </aside>

    </div>

    <div class="mobile-fab" onclick="openModal()">
        <i class="fas fa-shopping-cart"></i>
        <span class="mobile-badge" id="mobile-count">0</span>
    </div>

    <div class="modal" id="cart-modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:var(--dark-blue)">Tu Carrito</h3>
                <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div id="mobile-discount-bar" class="discount-alert" style="display:none;"></div>
            <div id="mobile-cart-items" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
            <div id="mobile-cart-summary"></div>
            <a href="#" class="btn-checkout" onclick="checkout()">Pedir por WhatsApp</a>
            <button class="btn-keep-shopping" onclick="closeModal()">Seguir comprando</button>
        </div>
    </div>

    <script>
        const SHEET_ID = '1Q7JY9uNuRk9dVaeGL7hPe9CTsp4u-dmNcqayOZUubqc'; 
        const API_TIENDA = `https://opensheet.elk.sh/${SHEET_ID}/tienda`;
        const API_CONFIG = `https://opensheet.elk.sh/${SHEET_ID}/config`;

        let PROMO_META = 99999, PROMO_BONO = 0;
        let allProducts = [], cart = [];
        let isSummaryExpanded = true;

        setInterval(() => {
            const d = new Date();
            const h = 23 - d.getHours(), m = 59 - d.getMinutes(), s = 59 - d.getSeconds();
            document.getElementById('countdown').innerHTML = `<span>${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}</span>`;
        }, 1000);

        async function loadStoreData() {
            try {
                const [resTienda, resConfig] = await Promise.all([ fetch(API_TIENDA), fetch(API_CONFIG) ]);
                const dataTienda = await resTienda.json();
                try {
                    const dataConfig = await resConfig.json();
                    if(dataConfig && dataConfig.length > 0) {
                        dataConfig.forEach(r => {
                            if(r.dato === 'meta') PROMO_META = parseFloat(r.valor);
                            if(r.dato === 'bono') PROMO_BONO = parseFloat(r.valor);
                        });
                    }
                } catch(e){}

                if(!dataTienda || dataTienda.length === 0 || dataTienda.error) return;

                allProducts = dataTienda.map(item => ({
                    ...item,
                    precio: parseFloat(item.precio) || 0,
                    stock: parseInt(item.stock) || 0,
                    descuento: parseInt(item.descuento) || 0,
                    categoria: item.categoria ? item.categoria.toLowerCase() : 'varios'
                }));

                generateCategories(); // Generar botones autom√°ticamente
                renderProducts(allProducts);

            } catch (e) { console.error(e); }
        }

        // --- FUNCI√ìN M√ÅGICA PARA CREAR BOTONES DE CATEGOR√çAS ---
        function generateCategories() {
            const uniqueCats = ['todos', ...new Set(allProducts.map(p => p.categoria))];
            const container = document.getElementById('dynamicCategories');
            container.innerHTML = ''; 

            uniqueCats.forEach(cat => {
                let btn = document.createElement('div');
                btn.className = 'cat-pill';
                if(cat === 'todos') btn.classList.add('active');
                
                // Capitalizar primera letra (ej: "faldas" -> "Faldas")
                btn.innerText = cat.charAt(0).toUpperCase() + cat.slice(1);
                
                btn.onclick = () => filterProducts(cat, btn);
                container.appendChild(btn);
            });
        }

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid'); grid.innerHTML = ''; 
            if(products.length === 0) { grid.innerHTML = '<p style="padding:20px; grid-column:1/-1; text-align:center">No hay productos.</p>'; return; }

            products.forEach(prod => {
                let img = prod.imagen || 'https://via.placeholder.com/300';
                let price = prod.precio;
                let oldPriceHtml = '', finalPrice = price;

                if(prod.descuento > 0) {
                    finalPrice = price - (price * prod.descuento / 100);
                    oldPriceHtml = `<span class="original-price">S/ ${price.toFixed(2)}</span>`;
                } else {
                    oldPriceHtml = `<span class="original-price">S/ ${(price * 1.2).toFixed(2)}</span>`;
                }
                
                let dealTag = prod.descuento > 0 ? `<div class="deal-tag">‚ö° -${prod.descuento}%</div>` : '';
                let btn = prod.stock > 0 
                    ? `<button class="btn-add-cart" onclick="addToCart('${prod.nombre}', ${finalPrice})">A√±adir</button>`
                    : `<button class="btn-add-cart" style="background:#eee; color:#999; border:none;" disabled>Agotado</button>`;

                grid.innerHTML += `
                    <div class="product-card" onclick="addToCart('${prod.nombre}', ${finalPrice})"> 
                        <div class="img-wrapper"><img src="${img}" onerror="this.src='https://via.placeholder.com/300'">${dealTag}</div>
                        <div class="info-wrapper">
                            <div class="p-title">${prod.nombre}</div>
                            <div class="price-row"><span class="current-price">S/ ${finalPrice.toFixed(2)}</span>${oldPriceHtml}</div>
                            ${btn}
                        </div>
                    </div>`;
            });
        }

        function addToCart(name, price) {
            event.stopPropagation();
            let existing = cart.find(i => i.name === name);
            if (existing) existing.quantity++; else cart.push({ name, price, quantity: 1 });
            updateCartUI();
            const fab = document.querySelector('.mobile-fab'); fab.style.transform = 'scale(1.2)'; setTimeout(()=>fab.style.transform='scale(1)', 200);
        }

        function changeQty(index, change) {
            if(cart[index].quantity + change > 0) { cart[index].quantity += change; } 
            updateCartUI();
        }

        function removeFromCart(index) {
            cart.splice(index, 1); updateCartUI(); if(cart.length === 0) closeModal();
        }

        function toggleSummary() {
            isSummaryExpanded = !isSummaryExpanded; updateCartUI();
        }

        function updateCartUI() {
            let subtotal = 0, count = 0, itemsHtml = '';
            
            cart.forEach((item, index) => {
                subtotal += item.price * item.quantity; count += item.quantity;
                itemsHtml += `
                    <div class="cart-item-row">
                        <div class="cart-info"><span class="cart-name">${item.name}</span><span class="cart-price">S/ ${item.price.toFixed(2)} c/u</span></div>
                        <div class="cart-controls">
                            <button class="qty-btn" onclick="changeQty(${index}, -1)">-</button><span class="qty-val">${item.quantity}</span><button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                        </div>
                        <i class="fas fa-trash-alt btn-trash" onclick="removeFromCart(${index})"></i>
                    </div>`;
            });

            let discount = 0;
            let barMessage = '', barDisplay = 'block', barClass = 'discount-alert';

            if (cart.length === 0) { barDisplay = 'none'; } 
            else if (subtotal >= PROMO_META) {
                discount = PROMO_BONO; barMessage = `üéâ <b>¬°FELICIDADES!</b> Tienes S/ ${PROMO_BONO} OFF.`; barClass = 'discount-alert success';
            } else {
                let missing = PROMO_META - subtotal; barMessage = `üéÅ Agrega <b>S/ ${missing.toFixed(2)}</b> m√°s para descuento.`;
            }

            let total = subtotal - discount;
            let chevron = isSummaryExpanded ? 'fa-chevron-down' : 'fa-chevron-up';
            let toggleTxt = isSummaryExpanded ? 'Ocultar detalles' : 'Ver detalles';
            let displayDet = isSummaryExpanded ? 'block' : 'none';

            let summaryHtml = `
                <button class="summary-toggle-btn" onclick="toggleSummary()">${toggleTxt} <i class="fas ${chevron}"></i></button>
                <div class="summary-details" style="display:${displayDet}">
                    <div class="summary-row"><span>Subtotal</span> <span>S/ ${subtotal.toFixed(2)}</span></div>
                    ${discount > 0 ? `<div class="summary-row discount-text"><span>Descuento</span> <span>- S/ ${discount.toFixed(2)}</span></div>` : ''}
                </div>
                <div class="summary-total"><span>Total</span> <span>S/ ${total.toFixed(2)}</span></div>
            `;

            document.getElementById('desktop-cart-items').innerHTML = itemsHtml || '<p style="text-align:center;color:#999">Vac√≠o</p>';
            document.getElementById('desktop-cart-summary').innerHTML = summaryHtml;
            const db = document.getElementById('desktop-discount-bar'); db.innerHTML=barMessage; db.className=barClass; db.style.display=barDisplay;

            document.getElementById('mobile-cart-items').innerHTML = itemsHtml;
            document.getElementById('mobile-cart-summary').innerHTML = summaryHtml;
            const mb = document.getElementById('mobile-discount-bar'); mb.innerHTML=barMessage; mb.className=barClass; mb.style.display=barDisplay;
            
            document.getElementById('mobile-count').innerText = count;
        }

        function filterProducts(cat, btn) {
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            renderProducts(cat === 'todos' ? allProducts : allProducts.filter(p => p.categoria === cat));
        }

        function searchProducts() { 
            let val = document.getElementById('searchInput').value.toLowerCase(); 
            renderProducts(allProducts.filter(p => p.nombre.toLowerCase().includes(val))); 
        }

        function openModal() { document.getElementById('cart-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('cart-modal').style.display = 'none'; }
        
        function checkout() {
            if (cart.length === 0) return;
            let subtotal = cart.reduce((acc, i) => acc + (i.price * i.quantity), 0);
            let discount = subtotal >= PROMO_META ? PROMO_BONO : 0;
            let total = subtotal - discount;
            let msg = "Hola AMELI'S, pedido:%0A";
            cart.forEach(i => msg += `‚ñ™ ${i.quantity} x ${i.name} - S/ ${(i.price * i.quantity).toFixed(2)}%0A`);
            msg += `%0A----------------%0ASubtotal: S/ ${subtotal.toFixed(2)}`;
            if(discount>0) msg+=`%0ADescuento: -S/ ${discount}`;
            msg += `%0A*TOTAL: S/ ${total.toFixed(2)}*`;
            window.open(`https://wa.me/51904850808?text=${msg}`, '_blank');
        }

        loadStoreData();
    </script>
</body>
</html>